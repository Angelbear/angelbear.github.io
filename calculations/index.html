<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二年级数学练习</title>
    <style>
        @page {
            size: A4;
            margin: 0;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .column-wrapper {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 20px;
        }

        .column {
            break-inside: avoid;
            margin-bottom: 20px;
        }

        .calculation {
            padding: 5px;
            text-align: center;
            font-size: 18px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .missing-number {
            display: inline-block;
            width: 36px;
            height: 36px;
            border: 1px solid #000;
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <h1>二年级数学练习（100以内加减 & 9×9乘除）</h1>
    <div class="column-wrapper">
        <div class="column">
            <div class="calculations" id="calculations1"></div>
        </div>

        <div class="column">
            <div class="calculations" id="calculations2"></div>
        </div>

        <div class="column">
            <div class="calculations" id="calculations3"></div>
        </div>
    </div>

    <script>
        function getRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function pickOne(items) {
            return items[getRandomNumber(0, items.length - 1)];
        }

        function getRandomNumberExcluding(min, max, excludedValues, maxTries = 30) {
            const excluded = new Set(excludedValues);
            for (let i = 0; i < maxTries; i++) {
                const n = getRandomNumber(min, max);
                if (!excluded.has(n)) return n;
            }
            // Fallback: return min if it's not excluded; otherwise max.
            if (!excluded.has(min)) return min;
            return max;
        }

        // 二年级乘除：这里直接不出 ×1/÷1，因子限定 2..9
        function getFactor2to9() {
            return getRandomNumber(2, 9);
        }

        function box() {
            return '<span class="missing-number"></span>';
        }

        function formatExpression(tokens, missingIndex) {
            return tokens
                .map((t, i) => (i === missingIndex ? box() : String(t)))
                .join(' ');
        }

        // 100以内加减：a + b = c / a - b = c
        function generateAddSubOneStep() {
            const isAdd = Math.random() < 0.55;
            let a, b, c, op;

            if (isAdd) {
                // 避免出现 "+ 0"：b 至少为 1，因此 a 最多到 99
                a = getRandomNumber(1, 99);
                b = getRandomNumber(1, 100 - a);
                c = a + b;
                op = '+';
            } else {
                // 避免出现 "- 0"：b 至少为 1
                a = getRandomNumber(1, 100);
                b = getRandomNumber(1, a);
                c = a - b;
                op = '-';
            }

            // 缺项：a / b / 结果
            const missing = getRandomNumber(0, 2);
            const tokens = [a, op, b, '=', c];
            const missingIndex = missing === 0 ? 0 : missing === 1 ? 2 : 4;
            return formatExpression(tokens, missingIndex);
        }

        // 9×9 乘法：a × b = c
        function generateMultiply() {
            const a = getFactor2to9();
            const b = getFactor2to9();
            const c = a * b;

            const missing = getRandomNumber(0, 2);
            const tokens = [a, '×', b, '=', c];
            const missingIndex = missing === 0 ? 0 : missing === 1 ? 2 : 4;
            return formatExpression(tokens, missingIndex);
        }

        // 9×9 除法（整除）：c ÷ b = a
        function generateDivision() {
            const a = getFactor2to9();
            const b = getFactor2to9();
            const c = a * b;

            const missing = getRandomNumber(0, 2);
            const tokens = [c, '÷', b, '=', a];
            const missingIndex = missing === 0 ? 0 : missing === 1 ? 2 : 4;
            return formatExpression(tokens, missingIndex);
        }

        // 连续算式（加减）：a ± b ± c = result，过程不为负且<=100
        function generateAddSubChain() {
            // 采用“生成-校验-重试”，避免出现 "+ 0" / "- 0" 以及越界。
            for (let attempt = 0; attempt < 80; attempt++) {
                const op1 = pickOne(['+', '-']);
                const op2 = pickOne(['+', '-']);

                // 为了避免 op1 为 '+' 时出现 b=0，限制 a<=99
                const a = op1 === '+' ? getRandomNumber(10, 99) : getRandomNumber(10, 100);

                let bMin = 1;
                let bMax;
                if (op1 === '+') {
                    bMax = Math.min(50, 100 - a);
                } else {
                    // 避免第一步得到 0：b <= a-1
                    bMax = Math.min(50, a - 1);
                }
                if (bMax < bMin) continue;
                const b = getRandomNumber(bMin, bMax);

                const first = op1 === '+' ? a + b : a - b;
                if (first < 0 || first > 100) continue;

                let cMin = 1;
                let cMax;
                if (op2 === '+') {
                    cMax = Math.min(50, 100 - first);
                } else {
                    cMax = Math.min(50, first);
                }
                if (cMax < cMin) continue;
                const c = getRandomNumber(cMin, cMax);

                const result = op2 === '+' ? first + c : first - c;
                if (result < 0 || result > 100) continue;

                const missingSlot = getRandomNumber(0, 3);
                const tokens = [a, op1, b, op2, c, '=', result];
                const missingIndex = missingSlot === 0 ? 0 : missingSlot === 1 ? 2 : missingSlot === 2 ? 4 : 6;
                return formatExpression(tokens, missingIndex);
            }

            // 兜底：如果连续算式一直生成失败，就回退到单步题
            return generateAddSubOneStep();
        }

        // 连续算式（乘除）：x × y ÷ z = r（整除，且中间数不超过 81）
        function generateMulDivChain() {
            // 尽量避免出现 ÷1 或 ×1（仍保留极少概率出现 1）。
            const r = getFactor2to9();
            const z = getFactor2to9();
            const product = r * z; // <= 81

            // 选择一个 y（1..9）作为 product 的因数，优先不选 1
            const factors = [];
            const preferredFactors = [];
            for (let y = 1; y <= 9; y++) {
                if (product % y === 0) {
                    factors.push(y);
                    // 避免 y=1（会变成 ×1），也尽量避免 y=product（会导致 x=1）
                    if (y !== 1 && y !== product) preferredFactors.push(y);
                }
            }

            const y = preferredFactors.length > 0 ? pickOne(preferredFactors) : pickOne(factors);
            const x = product / y;

            // 兜底：如果还是出现 x=1（例如 product<=9 且选到了 y=product），重试
            if (x === 1) return generateMulDivChain();

            const missingSlot = getRandomNumber(0, 3);
            const tokens = [x, '×', y, '÷', z, '=', r];
            const missingIndex = missingSlot === 0 ? 0 : missingSlot === 1 ? 2 : missingSlot === 2 ? 4 : 6;
            return formatExpression(tokens, missingIndex);
        }

        function generateGrade2Calculation() {
            // 比例：加减(单步) 45%，乘除 40%，连续算式 15%
            const roll = Math.random();
            if (roll < 0.45) return generateAddSubOneStep();
            if (roll < 0.65) return generateMultiply();
            if (roll < 0.85) return generateDivision();
            return Math.random() < 0.7 ? generateAddSubChain() : generateMulDivChain();
        }

        function generateCalculations(columnNumber, numCalculations) {
            const calculationsElement = document.getElementById(`calculations${columnNumber}`);
            calculationsElement.innerHTML = '';

            for (let i = 0; i < numCalculations; i++) {
                const calculation = generateGrade2Calculation();
                const calculationDiv = document.createElement('div');
                calculationDiv.className = 'calculation';
                calculationDiv.innerHTML = calculation;
                calculationsElement.appendChild(calculationDiv);
            }
        }

        // Generate random equations for each column on page load
        window.addEventListener('load', function() {
            generateCalculations(1, 15); // 15 equations in column 1
            generateCalculations(2, 15); // 15 equations in column 2
            generateCalculations(3, 15); // 15 equations in column 3
        });
    </script>
</body>
</html>
